import discord
from discord import app_commands, ui
from discord.ext import commands
import json
import os
import datetime

# --- CONFIGURATION ---
TOKEN = 'putthetoken'
DATA_FILE = "inferno_db.json"

# --- DATABASE MANAGER ---
def load_data():
    if os.path.exists(DATA_FILE):
        try:
            with open(DATA_FILE, "r", encoding='utf-8') as f:
                return json.load(f)
        except: return {}
    return {}

def save_data(data):
    with open(DATA_FILE, "w", encoding='utf-8') as f:
        json.dump(data, f, indent=4, ensure_ascii=False)

def parse_die(die_str):
    try:
        return int(str(die_str).lower().replace('d', ''))
    except:
        return 4
    
# --- PLAYER ID GENERATOR ---
import random

def generate_player_id(char_type):
    prefix = "PS" if char_type == "Public Safety" else "CIV"
    num = random.randint(1000, 9999)
    return f"{prefix}-{num}"

# --- BOT SETUP ---
class InfernoBot(commands.Bot):
    def __init__(self):
        super().__init__(command_prefix='!', intents=discord.Intents.all())

    async def setup_hook(self):
        await self.tree.sync()
        print("‚úÖ System Ready: Select Faction -> Register")

    async def on_ready(self):
        print(f"üî• {self.user} is Ready.")

bot = InfernoBot()

# ==============================================================================
# üîò STEP 1: ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î (FACTION SELECTION)
# ==============================================================================
class RegisterTypeView(ui.View):
    def __init__(self):
        super().__init__(timeout=None)

    @ui.button(label="üëÆ ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£ (Public Safety)", style=discord.ButtonStyle.danger, emoji="ü™™")
    async def hunter_btn(self, interaction: discord.Interaction, button: ui.Button):
        # ‡∏ñ‡πâ‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏î‡∏á -> ‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà
        await interaction.response.send_modal(HunterModal())

    @ui.button(label="üèòÔ∏è ‡∏û‡∏•‡πÄ‡∏£‡∏∑‡∏≠‡∏ô / ‡πÄ‡∏≠‡∏Å‡∏ä‡∏ô (Civilian/Private)", style=discord.ButtonStyle.secondary, emoji="üè†")
    async def civilian_btn(self, interaction: discord.Interaction, button: ui.Button):
        # ‡∏ñ‡πâ‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏ó‡∏≤ -> ‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏û‡∏•‡πÄ‡∏£‡∏∑‡∏≠‡∏ô
        await interaction.response.send_modal(CivilianModal())

# ==============================================================================
# üìù STEP 2: ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (MODALS) - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡πà‡∏≠‡∏á Doc Link
# ==============================================================================

# ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏° A: ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà (‡∏°‡∏µ‡∏ä‡πà‡∏≠‡∏á Rank)
class HunterModal(ui.Modal, title="‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£: ‡πÅ‡∏ú‡∏ô‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞"):
    name_age = ui.TextInput(
        label="‡∏ä‡∏∑‡πà‡∏≠ ‡πÅ‡∏•‡∏∞ ‡∏≠‡∏≤‡∏¢‡∏∏ (Name / Age)",
        placeholder="‡πÄ‡∏ä‡πà‡∏ô: Aki Hayakawa / 20",
        style=discord.TextStyle.short,
        required=True
    )
    gender = ui.TextInput(
        label="‡πÄ‡∏û‡∏® (Gender)",
        placeholder="‡πÄ‡∏ä‡πà‡∏ô: Male",
        style=discord.TextStyle.short,
        required=True
    )
    # ‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ä‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠ Rank
    rank = ui.TextInput(
        label="‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà (Rank)",
        placeholder="‡πÄ‡∏ä‡πà‡∏ô:  C, Special Division 4",
        style=discord.TextStyle.short,
        required=True
    )
    # --- [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å Details ‡πÄ‡∏õ‡πá‡∏ô Doc Link ---
    doc_link = ui.TextInput(
        label="‡πÉ‡∏™‡πà‡∏•‡∏¥‡πâ‡∏á‡∏î‡∏≠‡∏Ñ (Doc Link)",
        placeholder="https://docs.google.com/...",
        style=discord.TextStyle.short,
        required=True
    )
    # ---------------------------------------------
    image_url = ui.TextInput(
        label="‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (Image URL)",
        placeholder="https://... (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)",
        required=False
    )

    async def on_submit(self, interaction: discord.Interaction):
        # ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏ï‡πà‡∏≠ (‡∏£‡∏∞‡∏ö‡∏∏ type="Public Safety")
        await process_registration(interaction, self, "Public Safety", self.rank.value)

# ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏° B: ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏•‡πÄ‡∏£‡∏∑‡∏≠‡∏ô (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Rank ‡πÄ‡∏õ‡πá‡∏ô Occupation)
class CivilianModal(ui.Modal, title="‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£: ‡∏û‡∏•‡πÄ‡∏£‡∏∑‡∏≠‡∏ô/‡πÄ‡∏≠‡∏Å‡∏ä‡∏ô"):
    name_age = ui.TextInput(
        label="‡∏ä‡∏∑‡πà‡∏≠ ‡πÅ‡∏•‡∏∞ ‡∏≠‡∏≤‡∏¢‡∏∏ (Name / Age)",
        placeholder="‡πÄ‡∏ä‡πà‡∏ô: Asa Mitaka / 17",
        style=discord.TextStyle.short,
        required=True
    )
    gender = ui.TextInput(
        label="‡πÄ‡∏û‡∏® (Gender)",
        placeholder="‡πÄ‡∏ä‡πà‡∏ô: Female",
        style=discord.TextStyle.short,
        required=True
    )
    # ‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ä‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠ ‡∏≠‡∏≤‡∏ä‡∏µ‡∏û
    occupation = ui.TextInput(
        label="‡∏≠‡∏≤‡∏ä‡∏µ‡∏û (Occupation)",
        placeholder="‡πÄ‡∏ä‡πà‡∏ô: ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô, ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡∏ã‡∏∑‡πâ‡∏≠, ‡∏ô‡∏±‡∏Å‡∏•‡πà‡∏≤‡πÄ‡∏≠‡∏Å‡∏ä‡∏ô",
        style=discord.TextStyle.short,
        required=True
    )
    # --- [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å Details ‡πÄ‡∏õ‡πá‡∏ô Doc Link ---
    doc_link = ui.TextInput(
        label="‡πÉ‡∏™‡πà‡∏•‡∏¥‡πâ‡∏á‡∏î‡∏≠‡∏Ñ (Doc Link)",
        placeholder="https://docs.google.com/...",
        style=discord.TextStyle.short,
        required=True
    )
    # ---------------------------------------------
    image_url = ui.TextInput(
        label="‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (Image URL)",
        placeholder="https://... (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)",
        required=False
    )

    async def on_submit(self, interaction: discord.Interaction):
        # ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏ï‡πà‡∏≠ (‡∏£‡∏∞‡∏ö‡∏∏ type="Civilian" ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏≠‡∏≤‡∏ä‡∏µ‡∏û‡πÑ‡∏õ‡πÅ‡∏ó‡∏ô Rank)
        await process_registration(interaction, self, "Civilian", f"Civ: {self.occupation.value}")

# ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
async def process_registration(interaction, modal, char_type, rank_or_job):
    # ‡πÅ‡∏¢‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏≠‡∏≤‡∏¢‡∏∏
    if "/" in modal.name_age.value:
        parts = modal.name_age.value.split("/")
        c_name = parts[0].strip()
        c_age = parts[1].strip() if len(parts) > 1 else "-"
    else:
        c_name = modal.name_age.value
        c_age = "-"

    # ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ß‡πâ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
    temp_data = {
        "name": c_name, 
        "age": c_age,
        "gender": modal.gender.value,
        "rank": rank_or_job,            # ‡∏Ñ‡πà‡∏≤ Rank ‡∏´‡∏£‡∏∑‡∏≠ ‡∏≠‡∏≤‡∏ä‡∏µ‡∏û ‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤
        "identity": modal.doc_link.value, # [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÄ‡∏Å‡πá‡∏ö Link Doc ‡∏•‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á identity
        "image": modal.image_url.value,
        "type": char_type               # ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£
    }
    
    # ‡πÑ‡∏õ‡∏™‡∏π‡πà‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Stat
    await interaction.response.send_message(
        content=f"üìù ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• **{char_type}: {c_name}** ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢...\n‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ: **‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡∏µ‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ (Stats)**",
        view=StatSelectionView(temp_data),
        ephemeral=True
    )

# ==============================================================================
# üìù STEP 2: ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (MODALS)
# ==============================================================================

class HunterModal(ui.Modal, title="‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£: ‡πÅ‡∏ú‡∏ô‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞"):
    name_age = ui.TextInput(label="‡∏ä‡∏∑‡πà‡∏≠ ‡πÅ‡∏•‡∏∞ ‡∏≠‡∏≤‡∏¢‡∏∏ (Name / Age)", placeholder="‡πÄ‡∏ä‡πà‡∏ô: Aki Hayakawa / 20", style=discord.TextStyle.short, required=True)
    gender = ui.TextInput(label="‡πÄ‡∏û‡∏® (Gender)", placeholder="‡πÄ‡∏ä‡πà‡∏ô: Male", style=discord.TextStyle.short, required=True)
    rank = ui.TextInput(label="‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà (Rank)", placeholder="‡πÄ‡∏ä‡πà‡∏ô: Rank C, Special Division 4", style=discord.TextStyle.short, required=True)
    doc_link = ui.TextInput(label="‡πÉ‡∏™‡πà‡∏•‡∏¥‡πâ‡∏á‡∏î‡∏≠‡∏Ñ (Doc Link)", placeholder="https://docs.google.com/...", style=discord.TextStyle.short, required=True)
    image_url = ui.TextInput(label="‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (Image URL)", placeholder="https://... (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)", required=False)

    async def on_submit(self, interaction: discord.Interaction):
        await process_registration(interaction, self, "Public Safety", self.rank.value)

class CivilianModal(ui.Modal, title="‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£: ‡∏û‡∏•‡πÄ‡∏£‡∏∑‡∏≠‡∏ô/‡πÄ‡∏≠‡∏Å‡∏ä‡∏ô"):
    name_age = ui.TextInput(label="‡∏ä‡∏∑‡πà‡∏≠ ‡πÅ‡∏•‡∏∞ ‡∏≠‡∏≤‡∏¢‡∏∏ (Name / Age)", placeholder="‡πÄ‡∏ä‡πà‡∏ô: Asa Mitaka / 17", style=discord.TextStyle.short, required=True)
    gender = ui.TextInput(label="‡πÄ‡∏û‡∏® (Gender)", placeholder="‡πÄ‡∏ä‡πà‡∏ô: Female", style=discord.TextStyle.short, required=True)
    occupation = ui.TextInput(label="‡∏≠‡∏≤‡∏ä‡∏µ‡∏û (Occupation)", placeholder="‡πÄ‡∏ä‡πà‡∏ô: ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô, ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡∏ã‡∏∑‡πâ‡∏≠", style=discord.TextStyle.short, required=True)
    doc_link = ui.TextInput(label="‡πÉ‡∏™‡πà‡∏•‡∏¥‡πâ‡∏á‡∏î‡∏≠‡∏Ñ (Doc Link)", placeholder="https://docs.google.com/...", style=discord.TextStyle.short, required=True)
    image_url = ui.TextInput(label="‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (Image URL)", placeholder="https://... (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)", required=False)

    async def on_submit(self, interaction: discord.Interaction):
        await process_registration(interaction, self, "Civilian", f"Civ: {self.occupation.value}")

async def process_registration(interaction, modal, char_type, rank_or_job):
    # ‡πÅ‡∏¢‡∏Å‡∏ä‡∏∑‡πà‡∏≠/‡∏≠‡∏≤‡∏¢‡∏∏
    if "/" in modal.name_age.value:
        parts = modal.name_age.value.split("/")
        c_name = parts[0].strip()
        c_age = parts[1].strip() if len(parts) > 1 else "-"
    else:
        c_name = modal.name_age.value
        c_age = "-"

    temp_data = {
        "name": c_name, "age": c_age,
        "gender": modal.gender.value,
        "rank": rank_or_job,
        "identity": modal.doc_link.value,
        "image": modal.image_url.value,
        "type": char_type
    }
    
    # ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Species ‡∏Å‡πà‡∏≠‡∏ô (Step 3.1)
    await interaction.response.send_message(
        content=f"üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢...\n‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ: **‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ú‡πà‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå (Select Species)**",
        view=SpeciesSelectionView(temp_data),
        ephemeral=True
    )

# ======================================================================
# üî∞ STEP 3.0 ‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢ (UNIT SELECTION)
# ======================================================================
class UnitSelectionView(ui.View):
    def __init__(self, char_data):
        super().__init__(timeout=300)
        self.char_data = char_data
        self.selected_unit = None

    unit_options = [
        discord.SelectOption(label="Special Division 4", value="Special Division 4", description="‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏õ‡∏£‡∏≤‡∏ö‡∏õ‡∏µ‡∏®‡∏≤‡∏à"),
        discord.SelectOption(label="Field Response Team", value="Field Response Team", description="‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á‡∏†‡∏≤‡∏Ñ‡∏™‡∏ô‡∏≤‡∏°"),
        discord.SelectOption(label="Intelligence Unit", value="Intelligence Unit", description="‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ç‡πà‡∏≤‡∏ß‡∏Å‡∏£‡∏≠‡∏á"),
        discord.SelectOption(label="Support & Logistics", value="Support & Logistics", description="‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô"),
        discord.SelectOption(label="Medical Team", value="Medical Team", description="‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÅ‡∏û‡∏ó‡∏¢‡πå")
    ]

    @ui.select(placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î...", options=unit_options)
    async def select_unit(self, interaction: discord.Interaction, select: ui.Select):
        self.selected_unit = select.values[0]
        select.placeholder = f"‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß: {self.selected_unit}"
        self.next_btn.disabled = False
        await interaction.response.edit_message(view=self)

    @ui.button(label="‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (Next)", style=discord.ButtonStyle.primary, disabled=True)
    async def next_btn(self, interaction: discord.Interaction, button: ui.Button):
        self.char_data["unit"] = self.selected_unit
        await interaction.response.edit_message(
            content=f"üß¨ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢: **{self.selected_unit}**\n‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ: **‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ú‡πà‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå (Species)**",
            view=SpeciesSelectionView(self.char_data)
        )

# ==============================================================================
# üß¨ STEP 3.1: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ú‡πà‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå (‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Hybrid/Devil)
# ==============================================================================
class SpeciesSelectionView(ui.View):
    def __init__(self, char_data):
        super().__init__(timeout=300)
        self.char_data = char_data
        self.selected_species = None

    # --- [UPDATED] ‡∏•‡∏ö Hybrid ‡πÅ‡∏•‡∏∞ Devil ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏•‡∏¥‡∏™‡∏ï‡πå‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏õ‡∏Å‡∏ï‡∏¥ ---
    species_options = [
        discord.SelectOption(label="üë§ ‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå (Human)", value="Human", description="‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏õ‡∏Å‡∏ï‡∏¥, ‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏õ‡∏µ‡∏®‡∏≤‡∏à‡πÑ‡∏î‡πâ"),
        discord.SelectOption(label="üëπ ‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå‡∏°‡∏≤‡∏£ (Fiend)", value="Fiend", description="‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏î, ‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ"),
    ]

    @ui.select(placeholder="üß¨ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ú‡πà‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå...", options=species_options, row=0)
    async def select_species(self, interaction: discord.Interaction, select: ui.Select):
        self.selected_species = select.values[0]
        select.placeholder = f"‚úÖ ‡πÄ‡∏ú‡πà‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå: {self.selected_species}"
        self.next_btn.disabled = False
        await interaction.response.edit_message(view=self)

    @ui.button(label="‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (Next) ‚û°Ô∏è", style=discord.ButtonStyle.primary, row=1, disabled=True)
    async def next_btn(self, interaction: discord.Interaction, button: ui.Button):
        self.char_data["species"] = self.selected_species
        await interaction.response.edit_message(
            content=f"‚úÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ú‡πà‡∏≤: **{self.selected_species}**\n‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢: **‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡∏û‡∏•‡∏±‡∏á (Attributes)**",
            view=StatSelectionView(self.char_data)
        )

# ==============================================================================
# üìä STEP 3.2: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤‡∏û‡∏•‡∏±‡∏á (STAT SELECTION VIEW)
# ==============================================================================
class StatSelectionView(ui.View):
    def __init__(self, char_data):
        super().__init__(timeout=300)
        self.char_data = char_data
        self.selections = {"STR": None, "DEX": None, "WILL": None, "INS": None}
    
    dice_options = [
        discord.SelectOption(label="d4 (Weak)", value="d4"),
        discord.SelectOption(label="d6 (Average)", value="d6"),
        discord.SelectOption(label="d8 (Skilled)", value="d8"),
        discord.SelectOption(label="d10 (Elite)", value="d10"),
        discord.SelectOption(label="d12 (Master)", value="d12"),
        discord.SelectOption(label="d20 (Legendary)", value="d20"),
    ]

    def check_complete(self):
        if all(v is not None for v in self.selections.values()):
            self.confirm_btn.disabled = False
        else:
            self.confirm_btn.disabled = True

    @ui.select(placeholder="üí™ ‡∏Ñ‡πà‡∏≤ Strength (‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏Å‡∏£‡πà‡∏á)", options=dice_options, row=0)
    async def s_str(self, interaction: discord.Interaction, select: ui.Select):
        val = select.values[0]; self.selections["STR"] = val; select.placeholder = f"‚úÖ Strength: {val}"
        self.check_complete(); await interaction.response.edit_message(view=self)

    @ui.select(placeholder="üèÉ ‡∏Ñ‡πà‡∏≤ Dexterity (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏•‡πà‡∏≠‡∏á‡πÅ‡∏Ñ‡∏•‡πà‡∏ß)", options=dice_options, row=1)
    async def s_dex(self, interaction: discord.Interaction, select: ui.Select):
        val = select.values[0]; self.selections["DEX"] = val; select.placeholder = f"‚úÖ Dexterity: {val}"
        self.check_complete(); await interaction.response.edit_message(view=self)

    @ui.select(placeholder="üî• ‡∏Ñ‡πà‡∏≤ Willpower (‡∏û‡∏•‡∏±‡∏á‡πÉ‡∏à)", options=dice_options, row=2)
    async def s_will(self, interaction: discord.Interaction, select: ui.Select):
        val = select.values[0]; self.selections["WILL"] = val; select.placeholder = f"‚úÖ Willpower: {val}"
        self.check_complete(); await interaction.response.edit_message(view=self)

    @ui.select(placeholder="üëÅÔ∏è ‡∏Ñ‡πà‡∏≤ Insight (‡∏õ‡∏±‡∏ç‡∏ç‡∏≤/‡πÑ‡∏´‡∏ß‡∏û‡∏£‡∏¥‡∏ö)", options=dice_options, row=3)
    async def s_ins(self, interaction: discord.Interaction, select: ui.Select):
        val = select.values[0]; self.selections["INS"] = val; select.placeholder = f"‚úÖ Insight: {val}"
        self.check_complete(); await interaction.response.edit_message(view=self)

    @ui.button(label="‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (Confirm)", style=discord.ButtonStyle.success, row=4, disabled=True)
    async def confirm_btn(self, interaction: discord.Interaction, button: ui.Button):
        data = load_data(); uid = str(interaction.user.id)
        if uid in data and not data[uid].get('meta', {}).get('is_dead', False):
             await interaction.response.send_message("‚ùå ‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß", ephemeral=True); return

        vals = {k: parse_die(v) for k, v in self.selections.items()}
        max_hp = vals["STR"] + vals["WILL"]
        def_val = vals["DEX"] + vals["WILL"]
        m_def_val = vals["INS"] + vals["WILL"]

        new_char = {
            "info": {
                "name": self.char_data["name"], "age": self.char_data["age"],
                "gender": self.char_data["gender"], "rank": self.char_data["rank"],
                "species": self.char_data["species"], 
                "image": self.char_data["image"], "type": self.char_data["type"]
            },
            "roleplay": {"identity": self.char_data["identity"], "bond": "-", "contracts": []},
            "stats": self.selections, "values": vals,
            "combat": {"hp": max_hp, "max_hp": max_hp, "def": def_val, "m_def": m_def_val, "sp": 5, "conditions": []},
            "inventory": [], "money": 1000,
            "meta": {"is_dead": False, "exp": 0, "created_at": str(datetime.date.today()), "discord_id": uid}
        }
        data[uid] = new_char; save_data(data)

        # Profile Card
        color = 0x8b0000 if self.char_data["type"] == "Public Safety" else 0x3498db
        embed = discord.Embed(title=f"üóÇÔ∏è PERSONNEL FILE: {new_char['info']['name']}", color=color)
        info = f"**Rank:** {new_char['info']['rank']}\n**Species:** {new_char['info']['species']}\n**Age:** {new_char['info']['age']} | **Gender:** {new_char['info']['gender']}"
        embed.add_field(name="üìã INFO", value=info, inline=False)
        embed.add_field(name="üìÇ DOSSIER LINK", value=f"[Click to Open Document]({new_char['roleplay']['identity']})", inline=False)
        stats = f"üí™STR:{self.selections['STR']} üèÉDEX:{self.selections['DEX']} üî•WILL:{self.selections['WILL']} üëÅÔ∏èINS:{self.selections['INS']}"
        combat = f"‚ù§Ô∏èHP: {max_hp} | üõ°Ô∏èDEF: {def_val} | üîÆM.DEF: {m_def_val}"
        embed.add_field(name="üìä STATS", value=stats, inline=False)
        embed.add_field(name="‚öîÔ∏è COMBAT", value=combat, inline=False)
        if new_char['info']['image']: embed.set_image(url=new_char['info']['image'])
        embed.set_footer(text=f"Affiliation: {self.char_data['type']} | Balance: 1,000¬•")

        await interaction.response.edit_message(content="‚úÖ **‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå**", embed=embed, view=None)

# ==============================================================================
# üõ†Ô∏è ADMIN TOOLS: MANAGE PLAYER & SET SPECIES
# ==============================================================================

# 1. Edit Info Modal (‡πÅ‡∏Å‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)
class AdminEditInfoModal(ui.Modal, title="Admin: Edit Info"):
    def __init__(self, target_id, current_data):
        super().__init__()
        self.target_id = target_id
        self.current_data = current_data
        
        # Pre-fill data
        self.char_name = ui.TextInput(label="Name", default=current_data['info']['name'], required=True)
        self.char_age = ui.TextInput(label="Age", default=current_data['info']['age'], required=True)
        self.char_rank = ui.TextInput(label="Rank", default=current_data['info']['rank'], required=True)
        self.doc_link = ui.TextInput(label="Doc Link", default=current_data['roleplay']['identity'], required=True)
        self.img_url = ui.TextInput(label="Image URL", default=current_data['info']['image'] or "", required=False)

        self.add_item(self.char_name); self.add_item(self.char_age); self.add_item(self.char_rank)
        self.add_item(self.doc_link); self.add_item(self.img_url)

    async def on_submit(self, interaction: discord.Interaction):
        data = load_data()
        if self.target_id in data:
            data[self.target_id]['info']['name'] = self.char_name.value
            data[self.target_id]['info']['age'] = self.char_age.value
            data[self.target_id]['info']['rank'] = self.char_rank.value
            data[self.target_id]['roleplay']['identity'] = self.doc_link.value
            data[self.target_id]['info']['image'] = self.img_url.value
            save_data(data)
            await interaction.response.send_message("‚úÖ Updated Info!", ephemeral=True)

# 2. Edit Vitals Modal (‡πÅ‡∏Å‡πâ HP/SP/Money)
class AdminEditVitalsModal(ui.Modal, title="Admin: Edit Vitals"):
    def __init__(self, target_id, current_data):
        super().__init__()
        self.target_id = target_id
        self.hp = ui.TextInput(label="Current HP", default=str(current_data['combat']['hp']))
        self.max_hp = ui.TextInput(label="Max HP", default=str(current_data['combat']['max_hp']))
        self.money = ui.TextInput(label="Money", default=str(current_data['money']))
        self.sp = ui.TextInput(label="SP", default=str(current_data['combat']['sp']))
        self.add_item(self.hp); self.add_item(self.max_hp); self.add_item(self.money); self.add_item(self.sp)

    async def on_submit(self, interaction: discord.Interaction):
        data = load_data()
        if self.target_id in data:
            try:
                data[self.target_id]['combat']['hp'] = int(self.hp.value)
                data[self.target_id]['combat']['max_hp'] = int(self.max_hp.value)
                data[self.target_id]['money'] = int(self.money.value)
                data[self.target_id]['combat']['sp'] = int(self.sp.value)
                save_data(data)
                await interaction.response.send_message("‚úÖ Updated Vitals!", ephemeral=True)
            except ValueError:
                await interaction.response.send_message("‚ùå Error: Please enter numbers only.", ephemeral=True)

# 3. Edit Stats Modal (‡πÅ‡∏Å‡πâ‡πÄ‡∏ï‡πã‡∏≤)
class AdminEditStatsModal(ui.Modal, title="Admin: Edit Stats"):
    def __init__(self, target_id, current_data):
        super().__init__()
        self.target_id = target_id
        self.str_stat = ui.TextInput(label="STR (e.g. d10)", default=current_data['stats']['STR'])
        self.dex_stat = ui.TextInput(label="DEX (e.g. d6)", default=current_data['stats']['DEX'])
        self.will_stat = ui.TextInput(label="WILL (e.g. d8)", default=current_data['stats']['WILL'])
        self.ins_stat = ui.TextInput(label="INS (e.g. d4)", default=current_data['stats']['INS'])
        self.add_item(self.str_stat); self.add_item(self.dex_stat); self.add_item(self.will_stat); self.add_item(self.ins_stat)

    async def on_submit(self, interaction: discord.Interaction):
        data = load_data()
        if self.target_id in data:
            stats = {"STR": self.str_stat.value, "DEX": self.dex_stat.value, "WILL": self.will_stat.value, "INS": self.ins_stat.value}
            vals = {k: parse_die(v) for k, v in stats.items()}
            
            data[self.target_id]['stats'] = stats
            data[self.target_id]['values'] = vals
            # Recalculate derived
            data[self.target_id]['combat']['def'] = vals['DEX'] + vals['WILL']
            data[self.target_id]['combat']['m_def'] = vals['INS'] + vals['WILL']
            
            save_data(data)
            await interaction.response.send_message("‚úÖ Updated Stats & Derived Values!", ephemeral=True)

# 4. Set Species View (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏ú‡πà‡∏≤ - ‡∏£‡∏ß‡∏°‡∏ï‡∏±‡∏ß‡∏•‡∏±‡∏ö)
class AdminSpeciesView(ui.View):
    def __init__(self, target_id):
        super().__init__()
        self.target_id = target_id

    # ‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡πÄ‡∏ú‡πà‡∏≤‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÉ‡∏´‡πâ Admin ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    options = [
        discord.SelectOption(label="üë§ Human", value="Human"),
        discord.SelectOption(label="üëπ Fiend", value="Fiend"),
        discord.SelectOption(label="‚õìÔ∏è Hybrid (Admin Only)", value="Hybrid", description="‡πÅ‡∏£‡∏£‡πå‡∏°‡∏≤‡∏Å"),
        discord.SelectOption(label="üòà Devil (Admin Only)", value="Devil", description="‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå"),
    ]

    @ui.select(placeholder="üîß Select New Species...", options=options)
    async def select_species(self, interaction: discord.Interaction, select: ui.Select):
        data = load_data()
        if self.target_id in data:
            data[self.target_id]['info']['species'] = select.values[0]
            save_data(data)
            await interaction.response.send_message(f"üß¨ Changed species to **{select.values[0]}**", ephemeral=True)

# 5. Main Admin Dashboard View
class AdminPlayerView(ui.View):
    def __init__(self, target_id, current_data):
        super().__init__(timeout=None)
        self.target_id = target_id
        self.data = current_data

    @ui.button(label="üìù Edit Info", style=discord.ButtonStyle.secondary, row=0)
    async def edit_info(self, interaction: discord.Interaction, button: ui.Button):
        await interaction.response.send_modal(AdminEditInfoModal(self.target_id, self.data))

    @ui.button(label="üìä Edit Stats", style=discord.ButtonStyle.primary, row=0)
    async def edit_stats(self, interaction: discord.Interaction, button: ui.Button):
        await interaction.response.send_modal(AdminEditStatsModal(self.target_id, self.data))

    @ui.button(label="‚ù§Ô∏è Edit Vitals", style=discord.ButtonStyle.success, row=1)
    async def edit_vitals(self, interaction: discord.Interaction, button: ui.Button):
        await interaction.response.send_modal(AdminEditVitalsModal(self.target_id, self.data))

    @ui.button(label="üß¨ Set Species", style=discord.ButtonStyle.primary, row=1)
    async def set_species(self, interaction: discord.Interaction, button: ui.Button):
        await interaction.response.send_message("üß¨ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ú‡πà‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡πÉ‡∏´‡∏°‡πà (‡∏£‡∏ß‡∏°‡πÄ‡∏ú‡πà‡∏≤‡∏•‡∏±‡∏ö):", view=AdminSpeciesView(self.target_id), ephemeral=True)

    @ui.button(label="üóëÔ∏è Delete", style=discord.ButtonStyle.danger, row=2)
    async def delete_char(self, interaction: discord.Interaction, button: ui.Button):
        data = load_data()
        if self.target_id in data:
            del data[self.target_id]
            save_data(data)
            await interaction.response.edit_message(content="üóëÔ∏è **Deleted Character Successfully.**", embed=None, view=None)

# ==============================================================================
# üéÆ MAIN COMMANDS
# ==============================================================================

@bot.tree.command(name="register", description="‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡πÉ‡∏´‡∏°‡πà")
async def start_register(interaction: discord.Interaction):
    data = load_data(); uid = str(interaction.user.id)
    if uid in data and not data[uid].get('meta', {}).get('is_dead', False):
        c_name = data[uid].get('info', {}).get('name', 'Unknown')
        await interaction.response.send_message(f"‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ **{c_name}** ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß", ephemeral=True); return
    embed = discord.Embed(title="üóÇÔ∏è ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ (Registration)", color=0x2b2d31)
    embed.description = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (Select Affiliation):"
    await interaction.response.send_message(embed=embed, view=RegisterTypeView(), ephemeral=True)

class AdminGroup(app_commands.Group):
    def __init__(self): super().__init__(name="admin", description="GM Tools")
    
    async def interaction_check(self, interaction: discord.Interaction):
        if interaction.user.guild_permissions.administrator: return True
        await interaction.response.send_message("‚õî GM Only", ephemeral=True); return False

    @app_commands.command(name="manage", description="‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô (Edit/Delete/Set Species)")
    async def manage(self, interaction: discord.Interaction, target: discord.Member):
        data = load_data(); uid = str(target.id)
        if uid not in data:
            await interaction.response.send_message("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ", ephemeral=True); return

        char = data[uid]
        embed = discord.Embed(title=f"üîß ADMIN DASHBOARD: {char['info']['name']}", color=0x2b2d31)
        embed.description = f"**Species:** {char['info']['species']}\n**Rank:** {char['info']['rank']}\n**HP:** {char['combat']['hp']}/{char['combat']['max_hp']}"
        embed.set_thumbnail(url=target.avatar.url if target.avatar else None)
        
        await interaction.response.send_message(embed=embed, view=AdminPlayerView(uid, char), ephemeral=True)

bot.tree.add_command(AdminGroup())
bot.run(TOKEN)
